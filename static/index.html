<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirrorOS - Advanced Prediction Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-cyan: #64ffda;
            --primary-blue: #448aff;
            --primary-purple: #7c4dff;
            --bg-dark: #0f0f23;
            --bg-medium: #1a1a2e;
            --bg-light: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b0bec5;
            --text-muted: #9e9e9e;
            --success: #81c784;
            --warning: #ffb74d;
            --error: #e57373;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 50%, var(--bg-light) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Layout */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .logo {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .tagline {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .header-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .beta-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .tier-badge {
            background: linear-gradient(45deg, var(--primary-purple), #9c27b0);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Interface Grid */
        .main-interface {
            display: grid;
            grid-template-columns: 420px 380px 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Glass Card Styling */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
        }

        /* Input Section */
        .input-section {
            height: fit-content;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .main-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .main-input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .small-input {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .small-input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            background: rgba(255, 255, 255, 0.12);
        }

        .simulate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border: none;
            border-radius: 12px;
            color: var(--bg-dark);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .simulate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.4);
        }

        .simulate-btn.loading {
            background: linear-gradient(45deg, #424242, #616161);
            cursor: not-allowed;
        }

        /* Sidebar Options */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .options-section h3 {
            margin-bottom: 20px;
            color: var(--primary-cyan);
            font-size: 1.1rem;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-group p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #424242;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-cyan);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
        }

        select option {
            background: var(--bg-medium);
            color: white;
        }

        .range-input {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            text-align: right;
            color: var(--primary-cyan);
            font-weight: 600;
        }

        /* Grounding Status */
        .grounding-status {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .grounding-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Results Section */
        .results-section {
            min-height: 600px;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-cyan);
        }

        .result-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Prediction Summary */
        .prediction-summary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(100, 255, 218, 0.2);
            position: relative;
            overflow: hidden;
        }

        .prediction-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-cyan), var(--primary-blue), var(--primary-purple));
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .headline-odds {
            text-align: center;
            margin-bottom: 20px;
        }

        .probability-display {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .confidence-interval {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .outcome-category {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        .highly-likely { background: rgba(76, 175, 80, 0.3); color: #81c784; }
        .likely { background: rgba(76, 175, 80, 0.2); color: #81c784; }
        .possible { background: rgba(255, 152, 0, 0.2); color: #ffb74d; }
        .challenging { background: rgba(244, 67, 54, 0.2); color: #e57373; }

        /* Target Analysis */
        .target-analysis-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .target-analysis-section h4 {
            color: var(--primary-cyan);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .target-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .metric-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .metric-value {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-cyan);
            margin-bottom: 10px;
        }

        .metric-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-cyan), var(--primary-blue));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .metric-fill.leverage {
            background: linear-gradient(90deg, var(--primary-purple), #9c27b0);
        }

        /* Drivers Section */
        .drivers-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .driver-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .driver-card h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--primary-cyan);
        }

        .driver-list {
            list-style: none;
        }

        .driver-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9rem;
            color: #e0e0e0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .driver-item:hover {
            padding-left: 5px;
            background: rgba(255, 255, 255, 0.02);
        }

        .driver-item:last-child {
            border-bottom: none;
        }

        .driver-impact {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .positive { color: var(--success); }
        .negative { color: var(--error); }

        /* Chain of Thought Process */
        .process-section {
            margin-bottom: 25px;
        }

        .process-toggle {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .process-toggle:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .process-content {
            display: none;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--primary-cyan);
        }

        .process-content.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .process-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .process-step:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .process-step.enhanced {
            border: 1px solid rgba(100, 255, 218, 0.3);
            background: rgba(100, 255, 218, 0.05);
        }

        .process-step.failed {
            border: 1px solid rgba(244, 67, 54, 0.3);
            background: rgba(244, 67, 54, 0.05);
        }

        .step-icon {
            color: var(--primary-cyan);
            font-weight: bold;
            min-width: 25px;
            font-size: 1.1rem;
        }

        .step-text {
            font-size: 0.9rem;
            line-height: 1.5;
            flex: 1;
        }

        .enhanced-badge {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            color: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .error-text {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Mathematical Breakdown */
        .math-breakdown-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
        }

        .math-breakdown-section.show {
            display: block;
        }

        .math-breakdown-section h4 {
            color: var(--primary-cyan);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .math-factors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .factor-group h5 {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .factor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .factor-name {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .factor-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .factor-value.positive {
            color: var(--success);
        }

        .factor-value.negative {
            color: var(--error);
        }

        .calculation-details {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--primary-cyan);
        }

        /* Narrative Section */
        .narrative-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .narrative-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .narrative-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-cyan);
        }

        .generate-story-btn {
            background: linear-gradient(45deg, var(--primary-purple), #9c27b0);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-story-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.4);
        }

        .generate-story-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .narrative-content {
            line-height: 1.6;
            color: #e0e0e0;
            font-size: 0.95rem;
            min-height: 100px;
        }

        .narrative-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .narrative-metadata span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Disclaimer */
        .disclaimer {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #ffecb3;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-interface {
                grid-template-columns: 1fr 380px;
            }
            
            .results-section {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 1000px) {
            .main-interface {
                grid-template-columns: 1fr;
            }
            
            .drivers-section,
            .target-metrics,
            .math-factors {
                grid-template-columns: 1fr;
            }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Advanced Options Panel */
        .advanced-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .advanced-toggle {
            color: var(--primary-cyan);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .advanced-content {
            margin-top: 15px;
            display: none;
        }

        .advanced-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">MirrorOS</h1>
            <p class="tagline">Advanced AI-Powered Prediction Engine</p>
            <div class="header-status">
                <span class="beta-badge">ALPHA v0.4.1</span>
                <div class="user-status">
                    <span class="tier-badge" id="user-tier">FREE</span>
                    <span class="usage-info">
                        Narratives: <span id="narratives-used">0</span>/<span id="narratives-limit">3</span> today
                    </span>
                </div>
            </div>
        </header>

        <!-- Main Interface -->
        <div class="main-interface">
            <!-- Input Section -->
            <div class="input-section glass-card">
                <form id="prediction-form">
                    <div class="form-group">
                        <label for="goal-input">
                            Describe your goal or situation:
                            <span class="tooltip">ℹ️
                                <span class="tooltiptext">Be specific about timeline, budget, and target (e.g., company name)</span>
                            </span>
                        </label>
                        <textarea 
                            id="goal-input" 
                            class="main-input" 
                            placeholder="Example: I want to get a software engineering job at Google within 6 months. I'm 28, have 3 years experience, budget is $5000/month for preparation..."
                            required
                        ></textarea>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label for="timeframe">Timeframe (optional)</label>
                            <input type="text" id="timeframe" class="small-input" placeholder="e.g., 6 months">
                        </div>
                        <div class="form-group">
                            <label for="context">Additional Context</label>
                            <input type="text" id="context" class="small-input" placeholder="Extra details">
                        </div>
                    </div>

                    <button type="submit" class="simulate-btn" id="predict-btn">
                        <span class="loading-spinner" style="display: none;"></span>
                        <span class="btn-text">Generate Prediction</span>
                    </button>
                </form>
            </div>

            <!-- Sidebar Options -->
            <div class="sidebar">
                <!-- Primary Options -->
                <div class="options-section glass-card">
                    <h3>Prediction Options</h3>
                    
                    <div class="option-group">
                        <label>
                            Enhanced Grounding
                            <label class="toggle-switch">
                                <input type="checkbox" id="enhanced-grounding">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <p>Research real-world data for better accuracy</p>
                    </div>

                    <div class="option-group">
                        <label for="domain">Domain</label>
                        <select id="domain">
                            <option value="auto">Auto-detect</option>
                            <option value="career">Career</option>
                            <option value="dating">Dating</option>
                            <option value="travel">Travel</option>
                            <option value="finance">Finance</option>
                            <option value="health">Health</option>
                        </select>
                    </div>

                    <div class="option-group">
                        <label for="confidence-level">Confidence Level</label>
                        <select id="confidence-level">
                            <option value="standard">Standard (90%)</option>
                            <option value="high">High (95%)</option>
                            <option value="conservative">Conservative (99%)</option>
                        </select>
                    </div>

                    <!-- Advanced Options -->
                    <div class="advanced-options">
                        <div class="advanced-toggle" onclick="toggleAdvanced()">
                            <span id="advanced-arrow">▶</span> Advanced Options
                        </div>
                        <div class="advanced-content" id="advanced-content">
                            <div class="option-group">
                                <label>
                                    Sensitivity Analysis
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sensitivity-analysis">
                                        <span class="slider"></span>
                                    </label>
                                </label>
                            </div>
                            <div class="option-group">
                                <label for="monte-carlo-draws">
                                    Monte Carlo Draws: <span class="range-value" id="mc-value">1000</span>
                                </label>
                                <input type="range" id="monte-carlo-draws" class="range-input" 
                                       min="100" max="10000" step="100" value="1000"
                                       oninput="document.getElementById('mc-value').textContent = this.value">
                            </div>
                            <div class="option-group">
                                <label>
                                    Generate Narrative
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="auto-narrative">
                                        <span class="slider"></span>
                                    </label>
                                </label>
                                <p>Auto-generate story for uncertain outcomes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grounding Status -->
                <div class="grounding-status glass-card">
                    <div class="status-indicator" id="grounding-status">
                        <span class="status-icon">⚪</span>
                        <span class="status-text">Baseline Coefficients</span>
                    </div>
                    <div class="grounding-details" id="grounding-details" style="display: none;">
                        <p>Studies analyzed: <span id="studies-count">0</span></p>
                        <p>Coefficients enhanced: <span id="coefficients-count">0</span></p>
                        <p>Sources: <span id="primary-sources">N/A</span></p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section glass-card" id="results-section">
                <div class="result-header">
                    <h2 class="result-title">Prediction Results</h2>
                    <div class="result-actions">
                        <button class="action-btn" onclick="shareResults()">📤 Share</button>
                        <button class="action-btn" onclick="saveResults()">💾 Save</button>
                        <button class="action-btn" onclick="exportResults()">📊 Export</button>
                    </div>
                </div>

                <!-- Prediction Summary -->
                <div class="prediction-summary">
                    <div class="headline-odds">
                        <div class="probability-display" id="probability-display">--.--%</div>
                        <div class="confidence-interval" id="confidence-interval">[--% - --%]</div>
                        <div class="outcome-category" id="outcome-category">CALCULATING</div>
                    </div>
                </div>

                <!-- Target Analysis -->
                <div class="target-analysis-section" id="target-analysis" style="display: none;">
                    <h4>🎯 Target Analysis</h4>
                    <div class="target-metrics">
                        <div class="metric-card">
                            <span class="metric-label">Goal Difficulty</span>
                            <span class="metric-value" id="goal-difficulty">0.00</span>
                            <div class="metric-bar">
                                <div class="metric-fill" id="difficulty-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">User Leverage</span>
                            <span class="metric-value" id="user-leverage">0.00</span>
                            <div class="metric-bar">
                                <div class="metric-fill leverage" id="leverage-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Target Selectivity</span>
                            <span class="metric-value" id="target-selectivity">0.00</span>
                            <div class="metric-bar">
                                <div class="metric-fill" id="selectivity-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success/Risk Drivers -->
                <div class="drivers-section">
                    <div class="driver-card">
                        <h4><span class="driver-icon">📈</span>Success Factors</h4>
                        <ul class="driver-list" id="positive-drivers">
                            <li class="driver-item">
                                <span class="driver-impact positive">↑</span>
                                <span>Analyzing...</span>
                            </li>
                        </ul>
                    </div>

                    <div class="driver-card">
                        <h4><span class="driver-icon">⚠️</span>Risk Factors</h4>
                        <ul class="driver-list" id="negative-drivers">
                            <li class="driver-item">
                                <span class="driver-impact negative">↓</span>
                                <span>Analyzing...</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Chain of Thought Process -->
                <div class="process-section">
                    <button class="process-toggle" onclick="toggleProcess()">
                        🔍 Show Chain of Thought
                        <span id="process-arrow">▼</span>
                    </button>
                    <div class="process-content" id="process-content">
                        <!-- Process steps will be dynamically added here -->
                    </div>
                </div>

                <!-- Mathematical Breakdown -->
                <div class="math-breakdown-section" id="math-breakdown">
                    <h4>📊 Mathematical Breakdown</h4>
                    <div class="math-factors">
                        <div class="factor-group">
                            <h5>Positive Factors</h5>
                            <div id="positive-factor-list">
                                <!-- Factors will be added dynamically -->
                            </div>
                        </div>
                        <div class="factor-group">
                            <h5>Negative Factors</h5>
                            <div id="negative-factor-list">
                                <!-- Factors will be added dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="calculation-details">
                        <p>Logit score: <span id="logit-score">0.000</span></p>
                        <p>P(success) = 1/(1 + e^(-<span id="logit-value">0.000</span>)) = <span id="final-prob">0.0%</span></p>
                    </div>
                </div>

                <!-- Narrative Section -->
                <div class="narrative-section">
                    <div class="narrative-header">
                        <h4 class="narrative-title">Prediction Narrative</h4>
                        <button class="generate-story-btn" id="narrative-btn" onclick="generateNarrative()">
                            ✨ Generate Story
                        </button>
                    </div>
                    <div class="narrative-content" id="narrative-content">
                        <em>Click "Generate Story" to create a personalized scenario based on your prediction...</em>
                    </div>
                    <div class="narrative-metadata" id="narrative-metadata" style="display: none;">
                        <span>Words: <span id="word-count">0</span></span>
                        <span>Cost: <span id="cost-estimate">$0.00</span></span>
                        <span>Usage: <span id="usage-remaining">3/10</span></span>
                    </div>
                </div>

                <!-- Disclaimer -->
                <div class="disclaimer">
                    <strong>⚠️ Important:</strong> This prediction is based on statistical modeling and historical patterns. Results are for informational purposes only and should not be considered as professional advice. Individual outcomes may vary significantly based on circumstances not captured in this analysis.
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = '/api';
        
        // Global state
        let currentPredictionResult = null;
        let processSteps = [];
        let userTier = 'free';
        let authToken = localStorage.getItem('mirroros_auth_token');
        let currentUser = null;

        // Toggle advanced options (global function)
        function toggleAdvanced() {
            const content = document.getElementById('advanced-content');
            const arrow = document.getElementById('advanced-arrow');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                arrow.textContent = '▶';
            } else {
                content.classList.add('show');
                arrow.textContent = '▼';
            }
        }

        // Toggle process visibility (global function)
        function toggleProcess() {
            const content = document.getElementById('process-content');
            const arrow = document.getElementById('process-arrow');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                arrow.textContent = '▼';
            } else {
                content.classList.add('show');
                arrow.textContent = '▲';
                // Show math breakdown too
                document.getElementById('math-breakdown').classList.add('show');
            }
        }

        // Initialize stars background
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numStars = 100;
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = Math.random() * 0.8 + 0.2;
                starsContainer.appendChild(star);
            }
        }

        // Generate process steps for display  
        function generateProcessSteps(params) {
            const steps = [
                {
                    icon: '[>]',
                    title: 'Input Analysis',
                    description: 'Extracting and normalizing user parameters',
                    details: {
                        'Parameters extracted': '7',
                        'Coverage': '85%',
                        'Confidence': 'High'
                    },
                    enhanced: false,
                    status: 'completed'
                },
                {
                    icon: '[+]',
                    title: 'Domain Detection',
                    description: 'Determining prediction domain',
                    details: {
                        'Domain': params.domain === 'auto' ? 'Career (auto-detected)' : params.domain,
                        'Confidence': '90%'
                    },
                    enhanced: false,
                    status: 'completed'
                },
                {
                    icon: '[+]',
                    title: 'Prediction Calculation',
                    description: 'Running AI prediction model',
                    details: {
                        'Model': 'Logistic regression',
                        'Features': '12'
                    },
                    enhanced: params.enhanced_grounding,
                    status: 'completed'
                }
            ];
            
            return steps;
        }
        
        // Update process steps display
        function updateProcessSteps(steps) {
            const container = document.getElementById('process-content');
            container.innerHTML = '';
            
            steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = `process-step ${step.enhanced ? 'enhanced' : ''} ${step.status === 'failed' ? 'failed' : ''}`;
                
                let stepContent = `
                    <span class="step-icon">${step.icon || '✓'}</span>
                    <div class="step-text">
                        <strong>${step.title}:</strong> ${step.description}
                        ${step.enhanced ? '<span class="enhanced-badge">Research-Enhanced</span>' : ''}
                `;
                
                if (step.details) {
                    stepContent += '<div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-secondary);">';
                    for (const [key, value] of Object.entries(step.details)) {
                        if (value !== null && value !== undefined) {
                            stepContent += `<div>• ${key}: ${value}</div>`;
                        }
                    }
                    stepContent += '</div>';
                }
                
                if (step.error) {
                    stepContent += `<div class="error-text">Error: ${step.error}</div>`;
                }
                
                stepContent += '</div>';
                stepDiv.innerHTML = stepContent;
                container.appendChild(stepDiv);
            });
        }

        // Update mathematical breakdown
        function updateMathBreakdown(mathData) {
            if (!mathData) return;
            
            const posContainer = document.getElementById('positive-factor-list');
            const negContainer = document.getElementById('negative-factor-list');
            
            posContainer.innerHTML = '';
            negContainer.innerHTML = '';
            
            // Add positive factors
            if (mathData.positive_factors) {
                mathData.positive_factors.forEach(factor => {
                    const item = document.createElement('div');
                    item.className = 'factor-item';
                    item.innerHTML = `
                        <span class="factor-name">${factor.name}</span>
                        <span class="factor-value positive">+${factor.contribution.toFixed(4)}</span>
                    `;
                    posContainer.appendChild(item);
                });
            }
            
            // Add negative factors
            if (mathData.negative_factors) {
                mathData.negative_factors.forEach(factor => {
                    const item = document.createElement('div');
                    item.className = 'factor-item';
                    item.innerHTML = `
                        <span class="factor-name">${factor.name}</span>
                        <span class="factor-value negative">${factor.contribution.toFixed(4)}</span>
                    `;
                    negContainer.appendChild(item);
                });
            }
            
            // Update calculation details
            if (mathData.logit_score !== undefined) {
                document.getElementById('logit-score').textContent = mathData.logit_score.toFixed(4);
                document.getElementById('logit-value').textContent = mathData.logit_score.toFixed(4);
                document.getElementById('final-prob').textContent = (mathData.probability * 100).toFixed(1) + '%';
            }
        }

        // Update target analysis
        function updateTargetAnalysis(data) {
            if (!data) return;
            
            const section = document.getElementById('target-analysis');
            section.style.display = 'block';
            
            // Update difficulty
            if (data.goal_difficulty !== undefined) {
                document.getElementById('goal-difficulty').textContent = data.goal_difficulty.toFixed(2);
                document.getElementById('difficulty-bar').style.width = (data.goal_difficulty * 100) + '%';
            }
            
            // Update leverage
            if (data.user_leverage !== undefined) {
                document.getElementById('user-leverage').textContent = data.user_leverage.toFixed(2);
                document.getElementById('leverage-bar').style.width = (data.user_leverage * 100) + '%';
            }
            
            // Update selectivity
            if (data.target_selectivity !== undefined) {
                document.getElementById('target-selectivity').textContent = data.target_selectivity.toFixed(2);
                document.getElementById('selectivity-bar').style.width = (data.target_selectivity * 100) + '%';
            }
        }

        // Update grounding status
        function updateGroundingStatus(enhanced, details) {
            const statusIcon = document.getElementById('grounding-status').querySelector('.status-icon');
            const statusText = document.getElementById('grounding-status').querySelector('.status-text');
            const detailsDiv = document.getElementById('grounding-details');
            
            if (enhanced) {
                statusIcon.textContent = '🔬';
                statusText.textContent = 'Research-Enhanced';
                statusIcon.style.color = 'var(--primary-cyan)';
                
                if (details) {
                    detailsDiv.style.display = 'block';
                    document.getElementById('studies-count').textContent = details.studies_count || 0;
                    document.getElementById('coefficients-count').textContent = details.coefficients_count || 0;
                    document.getElementById('primary-sources').textContent = details.primary_sources || 'Various';
                }
            } else {
                statusIcon.textContent = '⚪';
                statusText.textContent = 'Baseline Coefficients';
                statusIcon.style.color = 'var(--text-secondary)';
                detailsDiv.style.display = 'none';
            }
        }

        // Generate narrative
        async function generateNarrative() {
            const button = document.getElementById('narrative-btn');
            const content = document.getElementById('narrative-content');
            const metadata = document.getElementById('narrative-metadata');
            
            button.disabled = true;
            button.textContent = '⏳ Generating...';
            
            try {
                // Simulate API call to generate narrative
                const response = await simulateNarrativeGeneration(currentPredictionResult);
                
                if (response.generated) {
                    content.innerHTML = `<p>${response.narrative}</p>`;
                    document.getElementById('word-count').textContent = response.word_count;
                    document.getElementById('cost-estimate').textContent = response.cost_estimate;
                    document.getElementById('usage-remaining').textContent = response.usage_remaining;
                    metadata.style.display = 'flex';
                } else {
                    content.innerHTML = `<em>${response.reason || 'Unable to generate narrative'}</em>`;
                }
            } catch (error) {
                content.innerHTML = '<em>Error generating narrative. Please try again.</em>';
            } finally {
                button.disabled = false;
                button.textContent = '✨ Generate Story';
            }
        }

        // Simulate narrative generation (replace with actual API call)
        function simulateNarrativeGeneration(predictionResult) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const narrative = generateSampleNarrative(predictionResult);
                    resolve({
                        generated: true,
                        narrative: narrative,
                        word_count: narrative.split(' ').length,
                        cost_estimate: '$0.05',
                        usage_remaining: '2/3'
                    });
                }, 2000);
            });
        }

        // Generate sample narrative based on prediction
        function generateSampleNarrative(result) {
            if (!result) return "Unable to generate narrative without prediction results.";
            
            const probability = result.probability || 0.5;
            const factors = result.key_success_factors || [];
            
            if (probability > 0.7) {
                return `Based on your strong preparation and favorable conditions, the path to success appears clear. 
                        Your ${factors[0] || 'preparation'} provides a solid foundation, while your timeline allows 
                        for strategic positioning. Over the coming months, you'll leverage these advantages to 
                        systematically progress toward your goal. The key will be maintaining momentum and capitalizing 
                        on opportunities as they arise. With consistent effort and your current resources, achieving 
                        your objective is well within reach.`;
            } else if (probability > 0.4) {
                return `Your journey presents both opportunities and challenges that will require careful navigation. 
                        While ${factors[0] || 'certain factors'} work in your favor, you'll need to actively address 
                        the constraints you face. The coming months will involve strategic trade-offs and focused effort 
                        to improve your positioning. Success is possible, but will require adaptability and persistence. 
                        Consider strengthening your weaker areas while leveraging your existing advantages.`;
            } else {
                return `The path ahead presents significant challenges that will test your determination and resourcefulness. 
                        Current constraints create headwinds, but they're not insurmountable with the right approach. 
                        You'll need to be creative in overcoming obstacles and possibly adjust your timeline or strategy. 
                        Focus on incremental improvements and building momentum gradually. While the odds are challenging, 
                        many have succeeded from similar starting points through persistence and strategic pivots.`;
            }
        }

        // Share results
        function shareResults() {
            const probability = document.getElementById('probability-display').textContent;
            const text = `I just got a ${probability} prediction on MirrorOS! Check out this advanced AI prediction engine.`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'MirrorOS Prediction',
                    text: text,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text + ' ' + window.location.href);
                showNotification('Results copied to clipboard!');
            }
        }

        // Save results
        function saveResults() {
            const results = {
                prediction: currentPredictionResult,
                timestamp: new Date().toISOString(),
                options: getSelectedOptions()
            };
            
            localStorage.setItem('mirrorros_last_prediction', JSON.stringify(results));
            showNotification('Results saved locally!');
        }

        // Export results
        function exportResults() {
            if (!currentPredictionResult) return;
            
            const exportData = {
                timestamp: new Date().toISOString(),
                prediction: currentPredictionResult,
                process_steps: processSteps,
                options: getSelectedOptions()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `mirroros_prediction_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Get selected options
        function getSelectedOptions() {
            return {
                enhanced_grounding: document.getElementById('enhanced-grounding').checked,
                domain: document.getElementById('domain').value,
                confidence_level: document.getElementById('confidence-level').value,
                sensitivity_analysis: document.getElementById('sensitivity-analysis').checked,
                monte_carlo_draws: document.getElementById('monte-carlo-draws').value,
                auto_narrative: document.getElementById('auto-narrative').checked
            };
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
                color: var(--bg-dark);
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Handle form submission
        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Form submitted');
            
            const goalInput = document.getElementById('goal-input').value;
            const timeframe = document.getElementById('timeframe').value;
            const context = document.getElementById('context').value;
            const options = getSelectedOptions();
            
            console.log('Form data:', { goalInput, timeframe, context, options });
            
            if (!goalInput.trim()) {
                console.log('Goal input is empty');
                showNotification('Please describe your goal first!');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('predict-btn');
            const btnText = btn.querySelector('.btn-text');
            const spinner = btn.querySelector('.loading-spinner');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            
            if (options.enhanced_grounding) {
                btnText.textContent = 'Researching data...';
            } else {
                btnText.textContent = 'Analyzing...';
            }
            
            // Show results section
            const resultsSection = document.getElementById('results-section');
            resultsSection.classList.add('show');
            
            // Update grounding status
            updateGroundingStatus(options.enhanced_grounding, null);
            
            try {
                console.log('Making prediction request...');
                const result = await simulatePrediction({
                    goal: goalInput,
                    timeframe,
                    context,
                    ...options
                });
                
                console.log('Prediction result:', result);
                currentPredictionResult = result;
                
                // Update UI with results
                updatePredictionDisplay(result);
                showNotification('Prediction completed successfully!');
                
                // Update process steps if available
                if (result.process_steps) {
                    updateProcessSteps(result.process_steps);
                }
                
                // Update mathematical breakdown if available
                if (result.math_breakdown) {
                    updateMathBreakdown(result.math_breakdown);
                }
                
                // Update target analysis if available
                if (result.target_analysis) {
                    updateTargetAnalysis(result.target_analysis);
                }
                
                // Update grounding status with details
                if (options.enhanced_grounding && result.grounding_details) {
                    updateGroundingStatus(true, result.grounding_details);
                }
                
                // Auto-generate narrative if enabled and in uncertainty range
                if (options.auto_narrative && result.probability > 0.3 && result.probability < 0.7) {
                    setTimeout(() => generateNarrative(), 1000);
                }
                
            } catch (error) {
                console.error('Prediction error:', error);
                showNotification('Error generating prediction. Please try again.');
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'Generate Prediction';
            }
        });

        // Update prediction display
        function updatePredictionDisplay(result) {
            // Update probability
            document.getElementById('probability-display').textContent = 
                `${(result.probability * 100).toFixed(1)}%`;
            
            // Update confidence interval
            document.getElementById('confidence-interval').textContent = 
                `[${(result.ci_lower * 100).toFixed(1)}% - ${(result.ci_upper * 100).toFixed(1)}%]`;
            
            // Update outcome category
            const categoryEl = document.getElementById('outcome-category');
            categoryEl.textContent = result.outcome_category;
            categoryEl.className = `outcome-category ${result.outcome_class}`;
            
            // Update drivers
            const posDrivers = document.getElementById('positive-drivers');
            const negDrivers = document.getElementById('negative-drivers');
            
            posDrivers.innerHTML = '';
            negDrivers.innerHTML = '';
            
            result.positive_drivers.forEach(driver => {
                const li = document.createElement('li');
                li.className = 'driver-item';
                li.innerHTML = `
                    <span class="driver-impact positive">↑</span>
                    <span>${driver}</span>
                `;
                posDrivers.appendChild(li);
            });
            
            result.negative_drivers.forEach(driver => {
                const li = document.createElement('li');
                li.className = 'driver-item';
                li.innerHTML = `
                    <span class="driver-impact negative">↓</span>
                    <span>${driver}</span>
                `;
                negDrivers.appendChild(li);
            });
            
            // Reset narrative
            document.getElementById('narrative-content').innerHTML = 
                '<em>Click "Generate Story" to create a personalized scenario based on your prediction...</em>';
            document.getElementById('narrative-metadata').style.display = 'none';
        }

        // Authentication functions
        async function checkAuth() {
            if (!authToken) {
                await authenticateUser();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    updateUIForAuthenticatedUser();
                } else {
                    // Token invalid, re-authenticate
                    authToken = null;
                    localStorage.removeItem('mirroros_auth_token');
                    await authenticateUser();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                await authenticateUser();
            }
        }

        async function authenticateUser() {
            console.log('Attempting authentication...');
            try {
                const response = await fetch(`${API_BASE_URL}/auth/demo-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        demo: true
                    })
                });

                console.log('Auth response status:', response.status);

                if (response.ok) {
                    const authData = await response.json();
                    console.log('Auth successful:', authData);
                    authToken = authData.access_token;
                    currentUser = authData.user;
                    localStorage.setItem('mirroros_auth_token', authToken);
                    updateUIForAuthenticatedUser();
                    showNotification('Authenticated successfully!');
                } else {
                    const errorText = await response.text();
                    console.log('Demo auth failed:', response.status, errorText);
                    showNotification('Authentication failed, continuing in demo mode', 'error');
                }
            } catch (error) {
                console.error('Authentication failed:', error);
                showNotification('Authentication error: ' + error.message, 'error');
            }
        }

        function updateUIForAuthenticatedUser() {
            if (currentUser) {
                userTier = currentUser.tier || 'free';
                document.getElementById('user-tier').textContent = userTier.toUpperCase();
                console.log('Authenticated user:', currentUser);
            }
        }

        // Real API prediction call
        async function simulatePrediction(params) {
            console.log('simulatePrediction called with params:', params);
            
            const requestData = {
                goal: params.goal,
                timeframe: params.timeframe || '',
                context: params.context || '',
                options: {
                    enhanced_grounding: params.enhanced_grounding,
                    domain: params.domain === 'auto' ? undefined : params.domain,
                    confidence_level: params.confidence_level,
                    sensitivity_analysis: params.sensitivity_analysis,
                    monte_carlo_draws: parseInt(params.monte_carlo_draws || 1000)
                }
            };

            console.log('Request data:', requestData);

            const headers = {
                'Content-Type': 'application/json',
            };

            // Add auth header if we have a token
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
                console.log('Using auth token');
            } else {
                console.log('No auth token available');
            }

            console.log('Making fetch request to:', `${API_BASE_URL}/predict`);

            const response = await fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestData)
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                
                let error;
                try {
                    error = JSON.parse(errorText);
                } catch {
                    error = { message: errorText };
                }
                
                // Handle specific error cases
                if (response.status === 401) {
                    console.log('Authentication required, attempting to re-authenticate...');
                    await authenticateUser();
                    throw new Error('Please try again after authentication');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please try again later.');
                } else if (response.status === 503) {
                    throw new Error('Prediction service temporarily unavailable');
                }
                
                throw new Error(error.message || error.error || 'Prediction failed');
            }

            const result = await response.json();
            console.log('API response:', result);
            return transformAPIResponse(result, params);
        }

        // Transform API response to match UI expectations
        function transformAPIResponse(apiData, params) {
            const prediction = apiData.prediction_data || apiData;
            const metadata = apiData.metadata || {};
            
            return {
                probability: prediction.probability,
                ci_lower: prediction.confidence_interval?.lower || prediction.probability - 0.1,
                ci_upper: prediction.confidence_interval?.upper || prediction.probability + 0.1,
                outcome_category: prediction.outcome_category,
                outcome_class: getOutcomeClass(prediction.probability),
                positive_drivers: prediction.key_success_factors || [],
                negative_drivers: prediction.risk_factors || [],
                key_success_factors: prediction.key_success_factors || [],
                process_steps: generateProcessSteps(params),
                math_breakdown: generateMathBreakdown(prediction.probability),
                target_analysis: {
                    goal_difficulty: apiData.goal_difficulty || 0.5,
                    user_leverage: apiData.user_leverage || 0.3,
                    target_selectivity: apiData.target_selectivity || 0.4
                },
                grounding_details: apiData.grounding_details || null
            };
        }

        // Get outcome class for styling
        function getOutcomeClass(probability) {
            if (probability > 0.7) return 'highly-likely';
            if (probability > 0.5) return 'likely';
            if (probability > 0.3) return 'possible';
            return 'challenging';
        }


        // Generate mathematical breakdown
        function generateMathBreakdown(probability) {
            const logit = Math.log(probability / (1 - probability));
            
            return {
                positive_factors: [
                    { name: 'Budget Allocation', contribution: 0.3214 },
                    { name: 'Timeline Length', contribution: 0.2156 },
                    { name: 'Preparation Level', contribution: 0.1893 },
                    { name: 'Experience', contribution: 0.1234 }
                ],
                negative_factors: [
                    { name: 'Goal Difficulty', contribution: -0.4521 },
                    { name: 'Market Competition', contribution: -0.2134 },
                    { name: 'Constraint Tightness', contribution: -0.1567 }
                ],
                logit_score: logit,
                probability: probability
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            createStars();
            
            // Initialize authentication
            await checkAuth();
            
            // Load saved settings if available
            const savedSettings = localStorage.getItem('mirroros_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                // Apply saved settings to UI
                if (settings.enhanced_grounding !== undefined) {
                    document.getElementById('enhanced-grounding').checked = settings.enhanced_grounding;
                }
                if (settings.domain) {
                    document.getElementById('domain').value = settings.domain;
                }
                if (settings.confidence_level) {
                    document.getElementById('confidence-level').value = settings.confidence_level;
                }
            }
            
            // Save settings on change
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', () => {
                    const settings = getSelectedOptions();
                    localStorage.setItem('mirroros_settings', JSON.stringify(settings));
                });
            });
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const sharedGoal = urlParams.get('goal');
            if (sharedGoal) {
                document.getElementById('goal-input').value = decodeURIComponent(sharedGoal);
                showNotification('Shared prediction loaded!');
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter to submit
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    document.getElementById('prediction-form').dispatchEvent(new Event('submit'));
                }
                // Ctrl/Cmd + S to save results
                if ((e.ctrlKey || e.metaKey) && e.key === 's' && currentPredictionResult) {
                    e.preventDefault();
                    saveResults();
                }
                // Ctrl/Cmd + E to export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e' && currentPredictionResult) {
                    e.preventDefault();
                    exportResults();
                }
            });
            
            // Add hover effects for interactive elements
            document.querySelectorAll('.action-btn, .simulate-btn, .generate-story-btn').forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
            
            // Auto-save draft
            let draftTimer;
            document.getElementById('goal-input').addEventListener('input', (e) => {
                clearTimeout(draftTimer);
                draftTimer = setTimeout(() => {
                    localStorage.setItem('mirroros_draft', e.target.value);
                }, 1000);
            });
            
            // Load draft if available
            const savedDraft = localStorage.getItem('mirroros_draft');
            if (savedDraft && !document.getElementById('goal-input').value) {
                document.getElementById('goal-input').value = savedDraft;
            }
            
            // Clear draft on successful submission
            document.getElementById('prediction-form').addEventListener('submit', () => {
                localStorage.removeItem('mirroros_draft');
            });
        });

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>